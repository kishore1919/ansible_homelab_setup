---
- name: Check whether add_ssl_to_ports.py exists
  ansible.builtin.stat:
    path: "{{ scripts_dir }}/add_ssl_to_ports.py"
  register: add_ports_script

- name: Add ports to config file
  ansible.builtin.command:
    cmd: "/usr/bin/python3 {{ scripts_dir }}/add_ssl_to_ports.py"
  when: add_ports_script.stat.exists
  register: add_ports_result
  failed_when: add_ports_result.rc != 0

- name: Ensure devicelist.yaml exists
  ansible.builtin.copy:
    content: |
      ---
      # Initial device list
    dest: /opt/reverseproxy/devicelist.yaml
    owner: root
    group: root
    mode: '0644'
    force: no

- name: Check if CCL script exists
  ansible.builtin.stat:
    path: "{{ scripts_dir }}/change_ccldevice_name.sh"
  register: ccl_script

- name: Change CCL script permission to executable (if present)
  ansible.builtin.file:
    path: "{{ scripts_dir }}/change_ccldevice_name.sh"
    mode: '0755'
  when: ccl_script.stat.exists

- name: Execute CCL scripts
  ansible.builtin.shell:
    cmd: "bash {{ scripts_dir }}/change_ccldevice_name.sh"
  when: ccl_script.stat.exists and ccl_script.stat.executable
  register: ccl_result
  failed_when: ccl_result.rc != 0

- name: Check if static IP script exists
  ansible.builtin.stat:
    path: "{{ puppet_files_dir }}/make_ip_static.sh"
  register: static_ip_script

- name: Ensure compose directory exists
  ansible.builtin.file:
    path: "{{ compose_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure docker compose plugin installed (package check)
  ansible.builtin.package:
    name: docker-compose-plugin
    state: present

- name: Check if compose file exists (single-VM)
  ansible.builtin.stat:
    path: "{{ compose_dir }}/{{ 'sdwan-docker-compose.yml' if (vm_data_hash.values() | map('dict2items') | flatten | map(attribute='key') | select('match', '^ciscovmanage') | list | length > 0) else 'base-docker-compose.yml' }}"
  register: compose_file_stat

- name: Check if addDockerIPtoFacter script exists
  ansible.builtin.stat:
    path: "{{ scripts_dir }}/addDockerIPtoFacter.sh"
  register: docker_ip_script

- name: Check if create_device_list.py exists
  ansible.builtin.stat:
    path: "{{ scripts_dir }}/create_device_list.py"
  register: create_devicelist_script

- name: Check if create_multivm_device_list.py exists
  ansible.builtin.stat:
    path: "{{ scripts_dir }}/create_multivm_device_list.py"
  register: create_multivm_list_script

- name: Check if genEtcHostsFromFacter.py exists
  ansible.builtin.stat:
    path: "/opt/reverseproxy/genEtcHostsFromFacter.py"
  register: gen_hosts_script

- name: Check if addVmanageIpToHostsFile.py exists
  ansible.builtin.stat:
    path: "/opt/reverseproxy/addVmanageIpToHostsFile.py"
  register: addvmanage_script

- name: Check if facter directory exists
  ansible.builtin.stat:
    path: /etc/facter/facts.d
  register: facter_dir

- name: Check if multi-VM compose file exists
  ansible.builtin.stat:
    path: "{{ compose_dir }}/multivm-child-docker-compose.yml"
  register: multivm_compose

- name: Include multi-VM tasks
  ansible.builtin.include_tasks: multivm.yml
  when: multi_vm == 'yes'

- name: Include single-VM tasks
  ansible.builtin.include_tasks: singlevm.yml
  when: multi_vm != 'yes'

- name: Docker apps setup complete
  ansible.builtin.debug:
    msg: "Docker apps have been set up successfully."
