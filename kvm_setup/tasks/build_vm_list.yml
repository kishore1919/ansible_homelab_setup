---
# Build VM list from custom-underlay.yaml

- name: "Build kvm_vm_list from custom_underlay groups"
  ansible.builtin.set_fact:
    kvm_vm_list: >-
      {{
        (custom_underlay | dict2items | selectattr('key', 'match', '^underlay_') | map(attribute='value') | map('extract', ['vms']) | list | sum(start=[]))
        if custom_underlay is defined and (custom_underlay | dict2items | selectattr('key', 'match', '^underlay_') | list | length > 0)
        else []
      }}
    kvm_vm_source: "custom_underlay"
  when: custom_underlay is defined

- name: "Fallback: Build kvm_vm_list from cncloud__custom__underlay groups"
  ansible.builtin.set_fact:
    kvm_vm_list: >-
      {{
        (cncloud__custom__underlay | dict2items | selectattr('key', 'match', '^underlay_') | map(attribute='value') | map('extract', ['vms']) | list | sum(start=[]))
        if cncloud__custom__underlay is defined and (cncloud__custom__underlay | dict2items | selectattr('key', 'match', '^underlay_') | list | length > 0)
        else []
      }}
    kvm_vm_source: "cncloud__custom__underlay"
  when:
    - custom_underlay is not defined
    - cncloud__custom__underlay is defined

- name: "Extract raw VM data from custom_underlay_vars"
  ansible.builtin.set_fact:
    raw_vm_data: "{{ custom_underlay_vars['cncloud::custom::vm_data'] }}"
    kvm_vm_source: "custom_underlay_vars"
  when:
    - custom_underlay is not defined
    - cncloud__custom__underlay is not defined
    - custom_underlay_vars is defined
    - custom_underlay_vars['cncloud::custom::vm_data'] is defined

- name: "Initialize empty kvm_vm_list"
  ansible.builtin.set_fact:
    kvm_vm_list: []
  when: raw_vm_data is defined

- name: "Build kvm_vm_list from raw_vm_data"
  ansible.builtin.set_fact:
    kvm_vm_list: "{{ kvm_vm_list + [{'vm_name': item.key, 'definition': item.value}] }}"
  loop: "{{ raw_vm_data | dict2items | map(attribute='value') | map('dict2items') | list | sum(start=[]) }}"
  when: raw_vm_data is defined

- name: "Ensure kvm_vm_list is a list"
  ansible.builtin.set_fact:
    kvm_vm_list: "{{ kvm_vm_list | default([]) }}"
  when: kvm_vm_list is not defined or kvm_vm_list is not iterable

- name: "Debug: Final kvm_vm_list and source used"
  ansible.builtin.debug:
    msg: >-
      Source: {{ kvm_vm_source | default('none') }}
      Final kvm_vm_list: {{ kvm_vm_list | to_nice_yaml }}
  when: kvm_vm_list is defined
  changed_when: false
