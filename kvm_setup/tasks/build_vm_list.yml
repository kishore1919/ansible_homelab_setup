---
# Build VM list from custom-underlay.yaml structure
- name: Extract VM data from custom-underlay
  ansible.builtin.set_fact:
    kvm_vm_list: []
  when: cncloud__custom__vm_data is defined

- name: Process each VM definition
  ansible.builtin.set_fact:
    kvm_vm_list: "{{ kvm_vm_list + [{
      'vm_name': item.key,
      'definition': item.value
    }] }}"
  loop: "{{ cncloud__custom__vm_data | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: cncloud__custom__vm_data is defined

- name: Debug VM list
  ansible.builtin.debug:
    var: kvm_vm_list
  when: kvm_vm_list is defined 
