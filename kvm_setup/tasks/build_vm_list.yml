---
# Build VM list from custom-underlay.yaml

- name: "Check available configuration sources"
  ansible.builtin.set_fact:
    # Determine priority: custom_underlay first, then custom_underlay_vars
    config_source: >-
      {%- if custom_underlay is defined -%}
        custom_underlay
      {%- elif custom_underlay_vars is defined and 
            custom_underlay_vars['cncloud::custom::vm_data'] is defined -%}
        custom_underlay_vars
      {%- else -%}
        none
      {%- endif %}
  changed_when: false

- name: "Extract from custom_underlay source"
  ansible.builtin.set_fact:
    kvm_vm_list: >-
      {{
        custom_underlay | dict2items 
        | selectattr('key', 'search', '^underlay_')
        | map(attribute='value.vms')
        | selectattr('defined')
        | flatten
      }}
    kvm_vm_source: "custom_underlay"
  when: config_source == "custom_underlay"
  changed_when: false

- name: "Extract from custom_underlay_vars source"
  ansible.builtin.set_fact:
    kvm_vm_list: >-
      {%- set vms = [] -%}
      {%- for group in custom_underlay_vars['cncloud::custom::vm_data'].values() -%}
        {%- for vm_name, definition in group.items() -%}
          {%- set _ = vms.append({'vm_name': vm_name, 'definition': definition}) -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ vms }}
    kvm_vm_source: "custom_underlay_vars"
  when: config_source == "custom_underlay_vars"
  changed_when: false

- name: "Handle no configuration source"
  ansible.builtin.set_fact:
    kvm_vm_list: []
    kvm_vm_source: "none"
  when: config_source == "none"
  changed_when: false

- name: "Debug configuration extraction"
  ansible.builtin.debug:
    msg: >-
      Configuration source: {{ config_source }}
      Extracted {{ kvm_vm_list | default([]) | length }} VM(s)
      Source variable: {{ kvm_vm_source | default('not set') }}
  changed_when: false