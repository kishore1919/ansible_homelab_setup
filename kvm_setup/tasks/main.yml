---
- name: Create multiple KVM VMs using community.libvirt.virt
  collections:
    - community.libvirt

  tasks:
    - name: Ensure image pool dir exists
      ansible.builtin.file:
        path: "{{ kvm_image_pool }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Download base KVM image if not present
      ansible.builtin.get_url:
        url: "{{ kvm_image_url }}"
        dest: "{{ kvm_image_pool }}"
        url: "{{ kvm_image_url }}"    
        destination: "{{ kvm_image_pool }}"
        checksum: "sha256:{{ base_image_sha }}"
      register: download_image

    - name: convert iso to qcow2
      ansible.builtin.command: >
        qemu-img convert -O qcow2
        {{ kvm_image_pool }}/{{ base_image_name }}.iso
        {{ kvm_image_pool }}/{{ kvm_vm_name }}.qcow2
      creates: "{{ kvm_image_pool }}/{{ kvm_vm_name }}.qcow2"
      when: download_image.changed | default(false)

    - name: Create vm from the image
      community.libvirt.virt:
        name: "{{ kvm_vm_name }}"
        pool: "{{ kvm_image_pool }}"
        base_image: "{{ base_image_name }}.qcow2"
        ram_mb: "{{ vm_ram_mb }}"
        vcpus: "{{ vm_vcpus }}"
        disk_size: "{{ vm_disk_size }}"
        os_variant: "{{ os_variant }}"
        network: "{{ network }}"
        cpu_model: "{{ cpu_model }}"
        state: present

    - name: Start the VM
      community.libvirt.virt:
        name: "{{ kvm_vm_name }}"
        state: running 

