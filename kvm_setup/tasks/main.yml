---
# Main tasks for KVM setup adapted for custom-underlay.yaml
- name: "Ensure required packages are installed"
  ansible.builtin.package:
    name:
      - qemu-kvm
      - libvirt-daemon-system
      - libvirt-clients
      - bridge-utils
      - virtinst
      - virt-manager
      - cloud-image-utils
    state: present
  become: true

- name: "Check if custom-underlay.yaml exists at /etc/puppet/hiera/data/role/custom/ and load it"
  ansible.builtin.include_vars:
    file: "/etc/puppet/hiera/data/role/custom/custom-underlay.yaml"
    name: custom_underlay_vars
  ignore_errors: yes

- name: "Debug: Indicate if custom_underlay_vars was loaded"
  ansible.builtin.debug:
    msg: "custom_underlay_vars loaded: {{ custom_underlay_vars is defined }}"
  changed_when: false

- name: "Build VM list from custom-underlay YAML"
  ansible.builtin.include_tasks:
    file: build_vm_list.yml
  tags: build_vm_list

- name: "Debug: kvm_vm_list summary"
  ansible.builtin.debug:
    msg: >-
      VM list source: {{ kvm_vm_source | default('none') }}
      VM count: {{ (kvm_vm_list | length) | default(0) }}
  when: kvm_vm_list is defined
  changed_when: false

- name: "Provision VMs from kvm_vm_list"
  ansible.builtin.include_tasks:
    file: create_vm_single.yml
  loop: "{{ kvm_vm_list }}"
  loop_control:
    loop_var: vm
  when: kvm_vm_list is defined and kvm_vm_list | length > 0

- name: "Configure connections between VMs if defined"
  ansible.builtin.include_tasks:
    file: configure_connections.yml
  when: cncloud__custom__connections is defined
