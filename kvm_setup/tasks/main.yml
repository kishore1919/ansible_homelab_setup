---
# Main tasks for KVM setup adapted for custom-underlay.yaml
- name: "Ensure required packages are installed"
  ansible.builtin.package:
    name:
      - qemu-kvm
      - libvirt-daemon-system
      - libvirt-clients
      - bridge-utils
      - virtinst
      - virt-manager
      - cloud-image-utils
    state: present
  become: true

- name: "Debug: Check current working directory and file existence"
  ansible.builtin.shell: "pwd && ls -la custom-underlay.yaml 2>&1 || echo 'File not found'"
  register: debug_output
  changed_when: false

- name: "Debug: Show directory structure"
  ansible.builtin.shell: "find . -name 'custom-underlay.yaml' 2>/dev/null || echo 'No custom-underlay.yaml found'"
  register: find_output
  changed_when: false

- name: "Debug: Show output"
  ansible.builtin.debug:
    msg: "Current dir: {{ debug_output.stdout }}\nFind result: {{ find_output.stdout }}"

- name: "Debug: Check if custom-underlay.yaml exists at /etc/puppet/hiera/data/role/custom/ and load it"
  ansible.builtin.include_vars:
    file: "/etc/puppet/hiera/data/role/custom/custom-underlay.yaml"
    name: custom_underlay_vars
  ignore_errors: yes

- name: "Debug: Show loaded variables from custom-underlay.yaml"
  ansible.builtin.debug:
    msg: "Loaded vars: {{ custom_underlay_vars | to_nice_yaml }}"
  when: custom_underlay_vars is defined

- name: "Build VM list from custom-underlay YAML"
  ansible.builtin.include_tasks:
    file: build_vm_list.yml
  tags: build_vm_list

- name: "Debug: Final VM list after build_vm_list.yml"
  ansible.builtin.debug:
    msg: "Final kvm_vm_list: {{ kvm_vm_list | to_nice_yaml }}"
  tags: debug_vm_list

- name: "Provision VMs from kvm_vm_list"
  ansible.builtin.include_tasks:
    file: create_vm_single.yml
  loop: "{{ kvm_vm_list }}"
  loop_control:
    loop_var: vm
  when: kvm_vm_list is defined and kvm_vm_list | length > 0

- name: "Configure connections between VMs if defined"
  ansible.builtin.include_tasks:
    file: configure_connections.yml
  when: cncloud__custom__connections is defined
