---
# Create single VM from custom-underlay definition

- name: Set VM facts from definition
  ansible.builtin.set_fact:
    vm_name: "{{ vm.vm_name }}"
    vm_definition: "{{ vm.definition }}"
    vm_info: "{{ vm.definition.vm_info | default({}) }}"
    interfaces: "{{ vm.definition.interfaces | default({}) }}"
    natrules: "{{ vm.definition.natrules | default({}) }}"
    image_src: "{{ vm.definition.image_src | default('') }}"
    # image_dest = where we FIRST download the image (could be .img or .qcow2)
    image_dest: "{{ vm.definition.image_dest | default('/var/lib/libvirt/images/' + vm_name + '.img') }}"
    memory: "{{ vm.definition.memory | default('1024') }}"
    vcpu: "{{ vm.definition.vcpu | default('1') }}"
    commands: "{{ vm.definition.commands | default([]) }}"

- name: Derive base image and per-VM disk paths
  ansible.builtin.set_fact:
    # base_image_path = QCOW2 base image shared by all VMs using this source
    base_image_path: "{{ image_dest | regex_replace('\\.[^.]+$', '.qcow2') }}"
    # vm_disk_path = per-VM qcow2 overlay (unique per VM)
    vm_disk_path: "/var/lib/libvirt/images/{{ vm_name }}.qcow2"

- name: Debug VM facts
  ansible.builtin.debug:
    msg:
      - "Creating VM {{ vm_name }}"
      - "Download path: {{ image_dest }}"
      - "Base image (qcow2): {{ base_image_path }}"
      - "VM disk (overlay): {{ vm_disk_path }}"
      - "RAM: {{ memory }} MB"
      - "vCPUs: {{ vcpu }}"

# ---------------------------
# IMAGE DOWNLOAD + CONVERSION
# ---------------------------

- name: Download image from Google Cloud Storage if gs:// URL
  ansible.builtin.command:
    cmd: "gsutil -m cp {{ image_src }} {{ image_dest }}"
  args:
    creates: "{{ image_dest }}"
  when: image_src is search('^gs://')

# (Optional extension: you could add HTTP/local logic here later.)

- name: Ensure base image is qcow2 (convert if needed)
  ansible.builtin.command:
    cmd: "qemu-img convert -O qcow2 {{ image_dest }} {{ base_image_path }}"
  args:
    creates: "{{ base_image_path }}"
  when: image_dest != base_image_path

# ---------------------------------
# PER-VM DISK (INDEPENDENT OVERLAY)
# ---------------------------------

- name: Create per-VM qcow2 overlay disk
  ansible.builtin.command:
    cmd: >
      qemu-img create -f qcow2
      -b {{ base_image_path }}
      {{ vm_disk_path }}
  args:
    creates: "{{ vm_disk_path }}"

# ---------------
# VM CREATION
# ---------------

- name: Create VM using virt_install
  community.libvirt.virt_install:
    name: "{{ vm_name }}"
    memory: "{{ memory }}"
    vcpus: "{{ vcpu }}"
    disks:
      - path: "{{ vm_disk_path }}"
    import: true
    networks:
      - network: "default"
    graphics:
      type: vnc
      listen: 127.0.0.1
    cpu:
      model: "host-passthrough"

- name: Configure NAT rules if defined
  ansible.builtin.include_tasks: configure_nat.yml
  when: natrules | length > 0
