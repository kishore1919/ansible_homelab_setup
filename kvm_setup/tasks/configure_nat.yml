---
# Configure NAT rules for VM
- name: Set NAT facts
  ansible.builtin.set_fact:
    nat_rules: "{{ natrules | dict2items }}"

- name: Configure NAT rules using iptables
  ansible.builtin.command:
    cmd: >
      iptables -t nat -A PREROUTING
      -p tcp --dport {{ item.value.host_port }}
      -j DNAT --to-destination {{ item.value.nat_port }}
  loop: "{{ nat_rules }}"
  loop_control:
    label: "NAT rule for port {{ item.value.host_port }} -> {{ item.value.nat_port }}"
  when: nat_rules | length > 0

- name: Save iptables rules
  ansible.builtin.command:
    cmd: iptables-save > /etc/iptables.rules
  when: nat_rules | length > 0
